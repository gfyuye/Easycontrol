name: Build EasyControl APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Create missing files
        run: |
          cd easycontrol
          mkdir -p app/src/main/java/top/saymzx/easycontrol/app/helper/
          echo 'package top.saymzx.easycontrol.app.helper;' > app/src/main/java/top/saymzx/easycontrol/app/helper/ActiveHelper.java
          echo 'public class ActiveHelper {' >> app/src/main/java/top/saymzx/easycontrol/app/helper/ActiveHelper.java
          echo '    public static boolean active(String key) { return true; }' >> app/src/main/java/top/saymzx/easycontrol/app/helper/ActiveHelper.java
          echo '    public static boolean deactivate(String key) { return true; }' >> app/src/main/java/top/saymzx/easycontrol/app/helper/ActiveHelper.java
          echo '}' >> app/src/main/java/top/saymzx/easycontrol/app/helper/ActiveHelper.java
          mkdir -p app/src/main/res/raw/
          echo 'placeholder' > app/src/main/res/raw/easycontrol_server
      
      - name: Build APK
        id: build
        run: |
          cd easycontrol
          chmod +x gradlew
          ./gradlew :app:assembleDebug
          
          # ç¡®è®¤ APK å­˜åœ¨
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "âœ… APK æ„å»ºæˆåŠŸ"
            echo "APK è·¯å¾„: app/build/outputs/apk/debug/app-debug.apk"
            echo "æ–‡ä»¶å¤§å°: $(stat -c%s "app/build/outputs/apk/debug/app-debug.apk") å­—èŠ‚"
          else
            echo "âŒ APK æœªæ‰¾åˆ°ï¼Œæœç´¢æ‰€æœ‰ APK..."
            find . -name "*.apk" -type f
            exit 1
          fi
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: easycontrol-debug-apk
          path: easycontrol/app/build/outputs/apk/debug/app-debug.apk  # æ³¨æ„è¿™é‡ŒåŠ äº† easycontrol/ å‰ç¼€
          retention-days: 7
      
      - name: Success message
        run: |
          echo "âœ… Build successful!"
          echo "ğŸ“± APK: easycontrol/app/build/outputs/apk/debug/app-debug.apk"
          echo "â¬‡ï¸  ä¸‹è½½: ç‚¹å‡»ä¸Šæ–¹çš„ 'Summary' é€‰é¡¹å¡ï¼Œåœ¨ 'Artifacts' åŒºåŸŸä¸‹è½½"
