name: Build Android APK with Debug

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 检出代码
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史

    # 2. 设置 JDK 17
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. 缓存 Gradle 依赖
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('easycontrol/**/*.gradle*', 'easycontrol/gradle/wrapper/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # 4. 诊断步骤：检查项目结构
    - name: Inspect Project Structure
      run: |
        cd easycontrol
        echo "=== 项目结构 ==="
        find . -name "*.java" | head -20
        echo "=== build.gradle 内容 ==="
        head -50 app/build.gradle || echo "无app/build.gradle"
        echo "=== gradle.properties ==="
        cat gradle.properties 2>/dev/null || echo "无gradle.properties"

    # 5. 清理并构建（带详细日志）
    - name: Clean and Build with Detailed Logs
      id: build
      run: |
        cd easycontrol
        chmod +x ./gradlew
        
        # 先清理旧构建
        ./gradlew clean
        
        # 尝试构建，捕获详细输出
        echo "开始构建..."
        if ./gradlew assembleDebug --info 2>&1 | tee build.log; then
          echo "构建成功"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "构建失败"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "=== 构建日志最后100行 ==="
          tail -100 build.log
          
          # 尝试获取更具体的编译错误
          echo "=== 尝试编译Java源码 ==="
          ./gradlew :app:compileDebugJavaWithJavac --stacktrace 2>&1 | tail -200
          exit 1
        fi

    # 6. 如果构建成功，继续后续步骤
    - name: Find APK File
      if: steps.build.outputs.success == 'true'
      id: find-apk
      run: |
        APK_PATH=$(find easycontrol -name "*.apk" -type f | head -1)
        if [ -n "$APK_PATH" ]; then
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "✅ 找到 APK: $APK_PATH"
        else
          echo "❌ 构建成功但未找到APK"
          echo "所有生成的文件:"
          find easycontrol -name "*.apk" -type f
        fi

    - name: Upload APK artifact
      if: steps.build.outputs.success == 'true' && steps.find-apk.outputs.apk_path != ''
      uses: actions/upload-artifact@v4
      with:
        name: easycontrol-debug-apk
        path: ${{ steps.find-apk.outputs.apk_path }}
        retention-days: 7

    # 7. 上传构建日志（无论成功与否）
    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: easycontrol/build.log
        if-no-files-found: ignore
