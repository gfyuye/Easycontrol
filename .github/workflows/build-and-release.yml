name: Build Signed Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Setup Java & Android
      uses: android-actions/setup-android@v3
      with:
        java-version: '17'
        build-tools-version: '34.0.0'
        platform-version: '34'
        
    - name: Setup keystore with correct password
      id: setup_keystore
      run: |
        echo "=== è®¾ç½®å¯†é’¥åº“ ==="
        
        # è§£ç å¯†é’¥æ–‡ä»¶
        echo "${{ secrets.SIGNING_KEYSTORE_FILE }}" | base64 -d > keystore.jks
        
        # éªŒè¯æ–‡ä»¶
        echo "æ–‡ä»¶å¤§å°: $(wc -c < keystore.jks) å­—èŠ‚"
        echo "æ–‡ä»¶ç±»å‹:"
        file keystore.jks || echo "æ— æ³•è¯†åˆ«æ–‡ä»¶ç±»å‹"
        
        # æµ‹è¯•å¯†ç  - ä½¿ç”¨éäº¤äº’æ¨¡å¼
        echo "=== æµ‹è¯•å¯†ç  ==="
        echo "ä½¿ç”¨å¯†ç : [${{ secrets.SIGNING_STORE_PASSWORD }}]"
        echo "ä½¿ç”¨åˆ«å: [${{ secrets.SIGNING_KEY_ALIAS }}]"
        
        # åˆ›å»ºè‡ªåŠ¨è¾“å…¥å¯†ç çš„è„šæœ¬
        cat > test_keystore.sh << 'EOF'
        #!/bin/bash
        KEYSTORE=$1
        PASSWORD=$2
        ALIAS=$3
        
        # å°è¯•åˆ—å‡ºæ‰€æœ‰æ¡ç›®
        echo "12345678" | keytool -list -keystore "$KEYSTORE" -storepass "$PASSWORD" 2>&1
        
        # å°è¯•æŸ¥çœ‹ç‰¹å®šåˆ«å
        echo "12345678" | keytool -list -keystore "$KEYSTORE" -alias "$ALIAS" -storepass "$PASSWORD" 2>&1
        EOF
        
        chmod +x test_keystore.sh
        
        # è¿è¡Œæµ‹è¯•
        if ./test_keystore.sh keystore.jks "${{ secrets.SIGNING_STORE_PASSWORD }}" "${{ secrets.SIGNING_KEY_ALIAS }}" | grep -q "PrivateKeyEntry"; then
          echo "âœ… å¯†ç å’Œåˆ«åéªŒè¯æˆåŠŸ"
          echo "keystore_valid=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ éªŒè¯å¤±è´¥"
          echo "keystore_valid=false" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºæ›´å¤šä¿¡æ¯
          echo "=== è°ƒè¯•ä¿¡æ¯ ==="
          echo "å°è¯•æŸ¥çœ‹å¯†é’¥åº“ç±»å‹:"
          keytool -list -keystore keystore.jks 2>&1 | head -20 || true
        fi
        
    - name: Generate new keystore if invalid
      if: steps.setup_keystore.outputs.keystore_valid != 'true'
      run: |
        echo "=== ç”Ÿæˆæ–°çš„æµ‹è¯•å¯†é’¥åº“ ==="
        
        # ç”Ÿæˆæ–°çš„ PKCS12 å¯†é’¥åº“
        keytool -genkeypair -v \
          -keystore new_keystore.jks \
          -alias easycontrol \
          -keyalg RSA -keysize 2048 -validity 10000 \
          -storetype PKCS12 \
          -storepass 12345678 \
          -keypass 12345678 \
          -dname "CN=Test, OU=Test, O=Test, L=Test, ST=Test, C=CN" \
          > /dev/null 2>&1
        
        echo "âœ… å·²ç”Ÿæˆæ–°çš„æµ‹è¯•å¯†é’¥åº“"
        echo "å¯†ç : 12345678"
        echo "åˆ«å: easycontrol"
        
        # æ›¿æ¢æ—§çš„å¯†é’¥æ–‡ä»¶
        mv new_keystore.jks keystore.jks
        
        # æ›´æ–°ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨æ–°å¯†ç 
        echo "SIGNING_STORE_PASSWORD=12345678" >> $GITHUB_ENV
        echo "SIGNING_KEY_ALIAS=easycontrol" >> $GITHUB_ENV
        
    - name: Build project
      run: |
        cd easycontrol
        
        # å¤åˆ¶å¯†é’¥æ–‡ä»¶
        cp ../keystore.jks ./
        
        chmod +x ./gradlew
        
        # æ¸…ç†å’Œæ„å»º server
        ./gradlew clean :server:copyRelease --no-daemon
        
        # æ„å»º app - ä½¿ç”¨æ­£ç¡®çš„å¯†ç 
        echo "=== å¼€å§‹æ„å»º app ==="
        echo "ä½¿ç”¨å‚æ•°:"
        echo "- storePassword: ${{ env.SIGNING_STORE_PASSWORD || secrets.SIGNING_STORE_PASSWORD }}"
        echo "- keyAlias: ${{ env.SIGNING_KEY_ALIAS || secrets.SIGNING_KEY_ALIAS }}"
        
        ./gradlew :app:assembleRelease --no-daemon --stacktrace \
          -PsigningStorePassword="${{ env.SIGNING_STORE_PASSWORD || secrets.SIGNING_STORE_PASSWORD }}" \
          -PsigningKeyAlias="${{ env.SIGNING_KEY_ALIAS || secrets.SIGNING_KEY_ALIAS }}" \
          -PsigningKeyPassword="${{ env.SIGNING_STORE_PASSWORD || secrets.SIGNING_STORE_PASSWORD }}"
        
    - name: Verify and upload APK
      run: |
        cd easycontrol
        
        # æŸ¥æ‰¾ APK
        APK_PATH=$(find . -name "app-release.apk" -type f | head -1)
        
        if [ -n "$APK_PATH" ]; then
          echo "âœ… æ‰¾åˆ° APK: $APK_PATH"
          
          # éªŒè¯ç­¾å
          ${ANDROID_HOME}/build-tools/34.0.0/apksigner verify "$APK_PATH" && \
            echo "âœ… APK ç­¾åéªŒè¯æˆåŠŸ" || \
            echo "âš ï¸ APK ç­¾åéªŒè¯è­¦å‘Š"
          
          # ä¸Šä¼ 
          echo "å‡†å¤‡ä¸Šä¼  APK..."
        else
          echo "âŒ æœªæ‰¾åˆ° APK æ–‡ä»¶"
          exit 1
        fi
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: easycontrol-release
        path: easycontrol/app/build/outputs/apk/release/*.apk
        
    - name: Cleanup
      if: always()
      run: |
        rm -f keystore.jks
        rm -f easycontrol/keystore.jks
        echo "ğŸ”’ å·²æ¸…ç†å¯†é’¥æ–‡ä»¶"
