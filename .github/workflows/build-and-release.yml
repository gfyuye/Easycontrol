name: Build and Release EasyControl

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Create missing files
        run: |
          cd easycontrol
          mkdir -p app/src/main/java/top/saymzx/easycontrol/app/helper/
          echo 'package top.saymzx.easycontrol.app.helper;' > app/src/main/java/top/saymzx/easycontrol/app/helper/ActiveHelper.java
          echo 'public class ActiveHelper {' >> app/src/main/java/top/saymzx/easycontrol/app/helper/ActiveHelper.java
          echo '    public static boolean active(String key) { return true; }' >> app/src/main/java/top/saymzx/easycontrol/app/helper/ActiveHelper.java
          echo '    public static boolean deactivate(String key) { return true; }' >> app/src/main/java/top/saymzx/easycontrol/app/helper/ActiveHelper.java
          echo '}' >> app/src/main/java/top/saymzx/easycontrol/app/helper/ActiveHelper.java
          mkdir -p app/src/main/res/raw/
          echo 'placeholder' > app/src/main/res/raw/easycontrol_server
      
      - name: Get version info
        id: version
        run: |
          # ä»gradle.propertiesæˆ–manifestè·å–ç‰ˆæœ¬ä¿¡æ¯
          cd easycontrol
          if [ -f "app/build.gradle" ]; then
            # å°è¯•ä»build.gradleæå–ç‰ˆæœ¬
            VERSION_NAME=$(grep -o "versionName ['\"]*[0-9.]*['\"]*" app/build.gradle | head -1 | sed "s/versionName ['\"]//" | sed "s/['\"]//")
            VERSION_CODE=$(grep -o "versionCode [0-9]*" app/build.gradle | head -1 | sed "s/versionCode //")
          fi
          
          # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤å€¼
          VERSION_NAME=${VERSION_NAME:-"1.0.0"}
          VERSION_CODE=${VERSION_CODE:-"1"}
          
          # å¦‚æœæ˜¯æ ‡ç­¾æ„å»ºï¼Œä½¿ç”¨æ ‡ç­¾å
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            VERSION_NAME="$TAG_NAME"
          fi
          
          # æ·»åŠ æ„å»ºæ—¶é—´æˆ³
          BUILD_TIME=$(date +%Y%m%d-%H%M%S)
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "build_number=$GITHUB_RUN_NUMBER" >> $GITHUB_OUTPUT
          
          echo "ç‰ˆæœ¬ä¿¡æ¯:"
          echo "ç‰ˆæœ¬å: $VERSION_NAME"
          echo "ç‰ˆæœ¬å·: $VERSION_CODE"
          echo "æ„å»ºæ—¶é—´: $BUILD_TIME"
          echo "æ„å»ºç¼–å·: $GITHUB_RUN_NUMBER"
      
      - name: Build APK
        id: build
        run: |
          cd easycontrol
          chmod +x gradlew
          
          echo "Building Debug APK..."
          ./gradlew :app:assembleDebug --stacktrace
          
          # åŸå§‹APKè·¯å¾„
          ORIGINAL_APK="app/build/outputs/apk/debug/app-debug.apk"
          
          # åˆ›å»ºå¸¦ç‰ˆæœ¬ä¿¡æ¯çš„æ–°æ–‡ä»¶å
          NEW_APK_NAME="EasyControl-v${{ steps.version.outputs.version_name }}-build${{ steps.version.outputs.build_number }}-debug.apk"
          
          # å¤åˆ¶å¹¶é‡å‘½åAPK
          cp "$ORIGINAL_APK" "$NEW_APK_NAME"
          
          # è¾“å‡ºè·¯å¾„
          echo "original_apk_path=easycontrol/$ORIGINAL_APK" >> $GITHUB_OUTPUT
          echo "apk_path=easycontrol/$NEW_APK_NAME" >> $GITHUB_OUTPUT
          echo "apk_name=$NEW_APK_NAME" >> $GITHUB_OUTPUT
          
          echo "APKæ„å»ºå®Œæˆ:"
          echo "åŸå§‹è·¯å¾„: $ORIGINAL_APK"
          echo "æ–°è·¯å¾„: $NEW_APK_NAME"
          echo "æ–‡ä»¶å¤§å°: $(stat -c%s "$NEW_APK_NAME") å­—èŠ‚"
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.apk_name }}
          path: ${{ steps.build.outputs.apk_path }}
          retention-days: 30
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          name: EasyControl ${{ steps.version.outputs.version_name }}
          tag_name: ${{ steps.version.outputs.tag_name }}
          body: |
            EasyControl Android App
            
            **ç‰ˆæœ¬ä¿¡æ¯**
            - ç‰ˆæœ¬: ${{ steps.version.outputs.version_name }}
            - æ„å»ºå·: ${{ steps.version.outputs.build_number }}
            - æ„å»ºæ—¶é—´: ${{ steps.version.outputs.build_time }}
            
            **ä¸‹è½½**
            - [EasyControl Debug APK](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag_name }}/${{ steps.build.outputs.apk_name }})
            
            **å®‰è£…è¯´æ˜**
            1. ä¸‹è½½APKæ–‡ä»¶
            2. åœ¨Androidè®¾å¤‡ä¸Šå…è®¸å®‰è£…æ¥è‡ªæœªçŸ¥æ¥æºçš„åº”ç”¨
            3. å®‰è£…APKå¹¶è¿è¡Œ
          files: ${{ steps.build.outputs.apk_path }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build summary
        run: |
          echo "âœ… æ„å»ºæˆåŠŸï¼"
          echo ""
          echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
          echo "  ç‰ˆæœ¬: ${{ steps.version.outputs.version_name }}"
          echo "  æ„å»ºå·: ${{ steps.version.outputs.build_number }}"
          echo "  æ„å»ºæ—¶é—´: ${{ steps.version.outputs.build_time }}"
          echo ""
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "ğŸš€ Release å·²åˆ›å»º:"
            echo "  APK: ${{ steps.build.outputs.apk_name }}"
            echo "  ä¸‹è½½: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag_name }}"
          else
            echo "ğŸ“¦ Artifact å·²ä¸Šä¼ :"
            echo "  APK: ${{ steps.build.outputs.apk_name }}"
            echo "  ä¸‹è½½: ç‚¹å‡»ä¸Šæ–¹çš„ 'Summary' é€‰é¡¹å¡ï¼Œåœ¨ 'Artifacts' åŒºåŸŸä¸‹è½½"
          fi
