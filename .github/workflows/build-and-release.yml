name: Build Android APK

on:
  push:
    branches: [ "main" ] # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ "main" ] # å‘ main åˆ†æ”¯æäº¤ PR æ—¶è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. è®¾ç½® JDK ç¯å¢ƒï¼ˆAndroidå¼€å‘æ¨èJDK 11æˆ–17ï¼‰
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin' # æ¨èä½¿ç”¨ Eclipse Temurin

    # 3. ç¼“å­˜ Gradle ä¾èµ–ï¼Œå¤§å¹…åŠ é€Ÿåç»­æ„å»º
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        # ç¼“å­˜è·¯å¾„
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        # ç”Ÿæˆç¼“å­˜é”®
        key: ${{ runner.os }}-gradle-${{ hashFiles('easycontrol/**/*.gradle*', 'easycontrol/gradle/wrapper/gradle-wrapper.properties') }}
        # å¦‚æœæœªå‘½ä¸­ç²¾ç¡®keyï¼Œåˆ™ä½¿ç”¨æ­¤keyæ¢å¤
        restore-keys: |
          ${{ runner.os }}-gradle-

    # 4. æˆäºˆæ‰§è¡Œæƒé™å¹¶æ„å»º Debug APK
    - name: Build APK with Gradle
      run: |
        cd easycontrol # å…³é”®æ­¥éª¤ï¼šè¿›å…¥é¡¹ç›®å­ç›®å½•
        chmod +x ./gradlew
        ./gradlew assembleDebug --stacktrace # --stacktrace ä¾¿äºå‡ºé”™æ—¶æ’æŸ¥

    # 5. æŸ¥æ‰¾ç”Ÿæˆçš„ APK æ–‡ä»¶ï¼ˆé€šå¸¸ä½ç½®ï¼‰
    - name: Find APK File
      id: find-apk
      run: |
        # åœ¨ easycontrol ç›®å½•ä¸‹æœç´¢ APK
        APK_PATH=$(find easycontrol -name "*.apk" -type f | head -1)
        if [ -n "$APK_PATH" ]; then
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "âœ… æ‰¾åˆ° APK: $APK_PATH"
          ls -la $(dirname "$APK_PATH")/ # åˆ—å‡ºæ‰€åœ¨ç›®å½•
        else
          echo "âŒ æœªæ‰¾åˆ° APK æ–‡ä»¶ï¼Œæ„å»ºäº§ç‰©å¯èƒ½åœ¨å…¶ä»–ä½ç½®ã€‚"
          echo "æ­£åœ¨æœç´¢æ„å»ºè¾“å‡ºç›®å½•..."
          find easycontrol -type d -name "outputs" | xargs -I {} find {} -type f 
          exit 1 # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåˆ™ä½¿æ­¥éª¤å¤±è´¥
        fi

    # 6. ä¸Šä¼  APK ä½œä¸ºå·¥ä½œæµåˆ¶å“ï¼Œä¾›ä¸‹è½½
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: easycontrol-debug-apk
        path: ${{ steps.find-apk.outputs.apk_path }}
        retention-days: 7 # åˆ¶å“ä¿ç•™å¤©æ•°

    # (å¯é€‰) 7. å¦‚æœæ„å»ºæˆåŠŸï¼Œè¾“å‡ºæˆåŠŸä¿¡æ¯
    - name: Build Success
      if: success()
      run: |
        echo "ğŸ‰ Android APK æ„å»ºæˆåŠŸï¼"
        echo "è¯·ç‚¹å‡»ä¸Šæ–¹çš„ 'Summary' é€‰é¡¹å¡ï¼Œåœ¨ 'Artifacts' åŒºåŸŸä¸‹è½½ APK æ–‡ä»¶ã€‚"
