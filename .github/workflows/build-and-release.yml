name: Build Signed Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Setup Java & Android
      uses: android-actions/setup-android@v3
      with:
        java-version: '17'
        build-tools-version: '34.0.0'
        platform-version: '34'
        
    - name: Verify and setup keystore
      id: verify_keystore
      run: |
        echo "=== æ­¥éª¤1: è§£ç å¯†é’¥æ–‡ä»¶ ==="
        echo "${{ secrets.SIGNING_KEYSTORE_FILE }}" | base64 -d > keystore.jks
        
        echo "æ–‡ä»¶å¤§å°: $(wc -c < keystore.jks) å­—èŠ‚"
        echo "æ–‡ä»¶ç±»å‹: $(file keystore.jks)"
        
        echo "=== æ­¥éª¤2: æµ‹è¯•å¯†ç å’Œåˆ«å ==="
        
        # å…ˆåˆ—å‡ºæ‰€æœ‰åˆ«åçœ‹çœ‹
        echo "å°è¯•åˆ—å‡ºæ‰€æœ‰åˆ«åï¼ˆå¯èƒ½éœ€è¦å¯†ç ï¼‰..."
        if keytool -list -keystore keystore.jks -storepass  "${{ secrets.SIGNING_STORE_PASSWORD }}"  2>/dev/null; then
          echo "âœ… å¯†ç æ­£ç¡®ï¼Œå¯ä»¥è®¿é—®å¯†é’¥åº“"
          echo "password_correct=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ å¯†ç é”™è¯¯æˆ–å¯†é’¥åº“æŸå"
          echo "password_correct=false" >> $GITHUB_OUTPUT
          
          # å°è¯•æŸ¥çœ‹å¯†é’¥åº“ç±»å‹
          echo "=== è°ƒè¯•ä¿¡æ¯ ==="
          echo "å°è¯•æŸ¥çœ‹å¯†é’¥åº“ä¿¡æ¯ï¼ˆå¯èƒ½éœ€è¦äº¤äº’è¾“å…¥ï¼‰:"
          keytool -list -keystore keystore.jks || true
        fi
        
        # æ£€æŸ¥åˆ«åæ˜¯å¦å­˜åœ¨
        if keytool -list -keystore keystore.jks -alias "${{ secrets.SIGNING_KEY_ALIAS }}" -storepass "${{ secrets.SIGNING_STORE_PASSWORD }}" 2>/dev/null; then
          echo "âœ… åˆ«åå­˜åœ¨ä¸”å¯†ç æ­£ç¡®"
          echo "alias_exists=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ åˆ«åä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯"
          echo "alias_exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Build if keystore is valid
      if: steps.verify_keystore.outputs.password_correct == 'true' && steps.verify_keystore.outputs.alias_exists == 'true'
      run: |
        cd easycontrol
        
        # å¤åˆ¶éªŒè¯è¿‡çš„å¯†é’¥æ–‡ä»¶
        cp ../keystore.jks ./
        
        chmod +x ./gradlew
        
        # æ¸…ç†å¹¶æ„å»º server
        ./gradlew clean :server:copyRelease --no-daemon
        
        # æ„å»º app - ä½¿ç”¨éªŒè¯è¿‡çš„é…ç½®
        echo "=== å¼€å§‹æ„å»º app ==="
        ./gradlew :app:assembleRelease --no-daemon --stacktrace \
          -PsigningStorePassword="${{ secrets.SIGNING_STORE_PASSWORD }}" \
          -PsigningKeyAlias="${{ secrets.SIGNING_KEY_ALIAS }}" \
          -PsigningKeyPassword="${{ secrets.SIGNING_STORE_PASSWORD }}"
        
    - name: Keystore validation failed
      if: steps.verify_keystore.outputs.password_correct != 'true' || steps.verify_keystore.outputs.alias_exists != 'true'
      run: |
        echo "âŒ å¯†é’¥åº“éªŒè¯å¤±è´¥"
        echo "å¯èƒ½çš„åŸå› :"
        echo "1. å¯†ç é”™è¯¯"
        echo "2. åˆ«åä¸å­˜åœ¨"
        echo "3. å¯†é’¥æ–‡ä»¶æŸå"
        echo ""
        echo "å»ºè®®:"
        echo "1. åœ¨æœ¬åœ°é‡æ–°ç”Ÿæˆå¯†é’¥"
        echo "2. æ›´æ–° GitHub Secrets"
        echo "3. ç¡®è®¤åˆ«åæ˜¯å¦æ­£ç¡®"
        exit 1
        
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: easycontrol-apk
        path: easycontrol/app/build/outputs/apk/release/app-release.apk
        
    - name: Cleanup
      if: always()
      run: |
        rm -f keystore.jks
        rm -f easycontrol/keystore.jks
        echo "ğŸ”’ å·²æ¸…ç†å¯†é’¥æ–‡ä»¶"
